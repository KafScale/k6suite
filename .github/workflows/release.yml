#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
name: release

on:
  push:
    tags:
      - "v*"

jobs:
  go-lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: kaf6
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: kaf6/go.mod
      - name: gofmt
        run: |
          test -z "$(gofmt -l .)"
      - name: go vet
        run: go vet ./...
      - name: go test
        run: go test ./...

  kafka-smoke:
    runs-on: ubuntu-latest
    services:
      kafka:
        image: bitnami/kafka:3.6
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_NODE_ID: "0"
          KAFKA_CFG_PROCESS_ROLES: "broker,controller"
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
          KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
          KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
          KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
          ALLOW_PLAINTEXT_LISTENER: "yes"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: build k6 with kafka extension
        run: |
          go install go.k6.io/xk6/cmd/xk6@latest
          xk6 build --with github.com/mostafa/xk6-kafka
      - name: wait for kafka
        run: |
          for i in {1..30}; do
            if nc -z 127.0.0.1 9092; then
              exit 0
            fi
            sleep 2
          done
          exit 1
      - name: kafka baseline smoke
        env:
          K6_PROFILE: kafka-local
          K6_TARGET: kafka
        run: |
          ./k6 run tests/k6/diagnose.js
          ./k6 run tests/k6/smoke_single.js

  kafscale-suite:
    runs-on: ubuntu-latest
    if: ${{ secrets.KAFSCALE_BROKERS != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: build k6 with kafka extension
        run: |
          go install go.k6.io/xk6/cmd/xk6@latest
          xk6 build --with github.com/mostafa/xk6-kafka
      - name: write ci profile
        env:
          KAFSCALE_BROKERS: ${{ secrets.KAFSCALE_BROKERS }}
          KAFSCALE_METRICS_URL: ${{ secrets.KAFSCALE_METRICS_URL }}
        run: |
          cat > config/profiles.json <<JSON
          {
            "default_profile": "ci-kafscale",
            "profiles": {
              "ci-kafscale": {
                "name": "CI KafScale",
                "description": "KafScale target from GitHub Actions",
                "brokers": ["${KAFSCALE_BROKERS}"],
                "kafscale": {
                  "metricsUrl": "${KAFSCALE_METRICS_URL}"
                }
              }
            }
          }
          JSON
      - name: kafscale release suite
        env:
          K6_PROFILE: ci-kafscale
          K6_TARGET: kafscale
        run: |
          ./k6 run tests/k6/diagnose.js
          ./k6 run tests/k6/smoke_metrics.js
          ./k6 run tests/k6/smoke_single.js
          ./k6 run tests/k6/smoke_concurrent.js
          ./k6 run tests/k6/smoke_shared.js
          ./k6 run tests/k6/smoke_topic_autocreate.js
          ./k6 run tests/k6/smoke_multi_producer_single_consumer.js
          ./k6 run tests/k6/smoke_consumer_group.js
